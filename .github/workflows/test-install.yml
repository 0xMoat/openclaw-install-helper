name: Test Install Scripts

on:
  push:
    branches: [main]
    paths:
      - 'install.sh'
      - 'install.ps1'
      - '.github/workflows/*.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  test-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run install script (Full User Experience)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ macOS å®‰è£…æµ‹è¯• - æ¨¡æ‹ŸçœŸå®ç”¨æˆ·ä½“éªŒ"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # æ˜¾ç¤ºåˆå§‹çŠ¶æ€
          echo "ğŸ“Š å®‰è£…å‰çŠ¶æ€:"
          echo "  Git:      $(command -v git > /dev/null && git --version || echo 'æœªå®‰è£…')"
          echo "  Node.js:  $(command -v node > /dev/null && node --version || echo 'æœªå®‰è£…')"
          echo "  pnpm:     $(command -v pnpm > /dev/null && pnpm --version || echo 'æœªå®‰è£…')"
          echo "  OpenClaw: $(command -v openclaw > /dev/null && openclaw --version || echo 'æœªå®‰è£…')"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""

          # è¿è¡Œå®‰è£…è„šæœ¬ï¼ˆæ˜¾ç¤ºå®Œæ•´è¾“å‡ºï¼‰
          chmod +x install.sh
          ./install.sh

          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""

      - name: Verify & Report Results
        run: |
          # åˆ·æ–° PATH
          if [[ -f "/opt/homebrew/bin/brew" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [[ -f "/usr/local/bin/brew" ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
          fi
          export PNPM_HOME="$HOME/Library/pnpm"
          if [[ -d "$PNPM_HOME" ]]; then
            export PATH="$PNPM_HOME:$PATH"
          fi
          if [[ -d "$HOME/.npm-global/bin" ]]; then
            export PATH="$HOME/.npm-global/bin:$PATH"
          fi

          echo "âœ… å®‰è£…ç»“æœéªŒè¯:"
          echo "  Git:      $(git --version 2>/dev/null || echo 'âŒ æœªå®‰è£…')"
          echo "  Node.js:  $(node --version 2>/dev/null || echo 'âŒ æœªå®‰è£…')"
          echo "  pnpm:     $(pnpm --version 2>/dev/null || echo 'âŒ æœªå®‰è£…')"
          echo "  OpenClaw: $(openclaw --version 2>/dev/null || echo 'âŒ æœªå®‰è£…')"
          echo ""

          # æ£€æŸ¥å‘½ä»¤è·¯å¾„
          echo "ğŸ“‚ å®‰è£…è·¯å¾„:"
          which node pnpm openclaw 2>/dev/null || echo "  éƒ¨åˆ†å‘½ä»¤å¯èƒ½éœ€è¦é‡å¯ç»ˆç«¯åä½¿ç”¨"

  # æµ‹è¯•å®Œå…¨å¹²å‡€çš„ macOS ç¯å¢ƒï¼ˆæ—  Homebrewã€æ—  Nodeï¼‰
  test-macos-clean:
    runs-on: macos-latest
    steps:
      - name: Download install script (without git clone)
        run: |
          curl -fsSL "https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh" -o "install.sh"

      - name: Clean environment setup
        run: |
          echo "ğŸ§¹ æ¸…ç†ç¯å¢ƒï¼Œæ¨¡æ‹Ÿå…¨æ–° macOS..."
          # å¸è½½ Homebrew
          if [[ -f "/opt/homebrew/bin/brew" ]] || [[ -f "/usr/local/bin/brew" ]]; then
            NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)" < /dev/null
            sudo rm -rf /opt/homebrew /usr/local/Homebrew /usr/local/Caskroom /usr/local/var/homebrew
            sudo rm -rf /Users/runner/.cache/Homebrew /Users/runner/.homebrew 2>/dev/null || true
          fi
          export PATH=$(echo "$PATH" | sed -E 's|/opt/homebrew/bin:/?|g' | sed -E 's|/opt/homebrew/sbin:/?|g' | sed -E 's|/usr/local/bin:/?|g')
          sudo rm -rf /opt/homebrew/bin/node /opt/homebrew/bin/npm /usr/local/bin/node /usr/local/bin/npm 2>/dev/null || true
          sudo rm -rf /usr/local/lib/node_modules /usr/local/include/node 2>/dev/null || true
          rm -rf ~/.npm ~/.nvm 2>/dev/null || true
          export PATH=$(echo "$PATH" | sed -E 's|/opt/homebrew/bin:/?|g' | sed -E 's|/usr/local/bin:/?|g')
          echo "  Homebrew: $(command -v brew || echo 'âœ“ å·²ç§»é™¤')"
          echo "  Node.js:  $(command -v node || echo 'âœ“ å·²ç§»é™¤')"
          echo ""

      - name: Run install script (Full User Experience)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ macOS å¹²å‡€ç¯å¢ƒå®‰è£…æµ‹è¯•"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          echo "ğŸ“Š å®‰è£…å‰çŠ¶æ€:"
          echo "  Homebrew: $(command -v brew > /dev/null || echo 'æœªå®‰è£…')"
          echo "  Node.js:  $(command -v node > /dev/null || echo 'æœªå®‰è£…')"
          echo "  Git:      $(command -v git > /dev/null || echo 'æœªå®‰è£…')"
          echo "  pnpm:     $(command -v pnpm > /dev/null || echo 'æœªå®‰è£…')"
          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""

          chmod +x install.sh
          ./install.sh

          echo ""
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""

      - name: Verify & Report Results
        run: |
          if [[ -f "/opt/homebrew/bin/brew" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [[ -f "/usr/local/bin/brew" ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
          fi
          export PNPM_HOME="$HOME/Library/pnpm"
          if [[ -d "$PNPM_HOME" ]]; then
            export PATH="$PNPM_HOME:$PATH"
          fi
          if [[ -d "$HOME/.npm-global/bin" ]]; then
            export PATH="$HOME/.npm-global/bin:$PATH"
          fi

          echo "âœ… å®‰è£…ç»“æœéªŒè¯:"
          echo "  Git:      $(git --version 2>/dev/null || echo 'âŒ æœªå®‰è£…')"
          echo "  Node.js:  $(node --version 2>/dev/null || echo 'âŒ æœªå®‰è£…')"
          echo "  pnpm:     $(pnpm --version 2>/dev/null || echo 'âŒ æœªå®‰è£…')"
          echo "  OpenClaw: $(openclaw --version 2>/dev/null || echo 'âŒ æœªå®‰è£…')"

  # æµ‹è¯•æœ‰ Git çš„ Windows ç¯å¢ƒ
  test-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run install script (Full User Experience)
        shell: pwsh
        run: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "ğŸ“‹ Windows å®‰è£…æµ‹è¯• - æ¨¡æ‹ŸçœŸå®ç”¨æˆ·ä½“éªŒ" -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""

          Write-Host "ğŸ“Š å®‰è£…å‰çŠ¶æ€:" -ForegroundColor Yellow
          Write-Host "  Git:      $(try { git --version } catch { 'æœªå®‰è£…' })"
          Write-Host "  Node.js:  $(try { node --version } catch { 'æœªå®‰è£…' })"
          Write-Host "  pnpm:     $(try { pnpm --version } catch { 'æœªå®‰è£…' })"
          Write-Host "  OpenClaw: $(try { openclaw --version } catch { 'æœªå®‰è£…' })"
          Write-Host ""
          Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray
          Write-Host ""

          Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
          .\install.ps1

          Write-Host ""
          Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray
          Write-Host ""

      - name: Verify & Report Results
        shell: pwsh
        run: |
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          $pnpmHome = "$env:LOCALAPPDATA\pnpm"
          if (Test-Path $pnpmHome) { $env:Path = "$pnpmHome;$env:Path" }
          $npmPath = "$env:APPDATA\npm"
          if (Test-Path $npmPath) { $env:Path = "$npmPath;$env:Path" }

          Write-Host "âœ… å®‰è£…ç»“æœéªŒè¯:" -ForegroundColor Green
          Write-Host "  Git:      $(try { git --version } catch { 'âŒ æœªå®‰è£…' })"
          Write-Host "  Node.js:  $(try { node --version } catch { 'âŒ æœªå®‰è£…' })"
          Write-Host "  pnpm:     $(try { pnpm --version } catch { 'âŒ æœªå®‰è£…' })"
          Write-Host "  OpenClaw: $(try { openclaw --version } catch { 'âŒ æœªå®‰è£…' })"

  # æµ‹è¯•å®Œå…¨å¹²å‡€çš„ Windows ç¯å¢ƒï¼ˆæ—  Gitã€æ—  Nodeï¼‰
  test-windows-clean:
    runs-on: windows-latest
    steps:
      - name: Download install script
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://raw.githubusercontent.com/${{ github.repository }}/main/install.ps1" -OutFile "install.ps1"

      - name: Clean environment setup
        shell: pwsh
        run: |
          Write-Host "ğŸ§¹ æ¸…ç†ç¯å¢ƒï¼Œæ¨¡æ‹Ÿå…¨æ–° Windows..." -ForegroundColor Yellow
          # å°è¯•å¸è½½ Gitï¼ˆå¿½ç•¥é”™è¯¯ï¼‰
          winget uninstall --id Git.Git --silent --accept-source-agreements 2>$null | Out-Null
          # choco å¸è½½å¯èƒ½å¤±è´¥ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰ï¼Œå¿½ç•¥é”™è¯¯
          if (Get-Command choco -ErrorAction SilentlyContinue) {
            choco uninstall git -y --skip-autouninstaller 2>$null | Out-Null
          }
          $env:Path = ($env:Path -split ';' | Where-Object { $_ -notlike '*Git*' }) -join ';'

          # ç¦ç”¨ winget
          Get-ChildItem -Path "$env:LOCALAPPDATA\Microsoft\WindowsApps" -Filter "winget.exe" -ErrorAction SilentlyContinue | ForEach-Object {
            Move-Item -Path $_.FullName -Destination "$($_.FullName).bak" -Force -ErrorAction SilentlyContinue
          }
          Get-ChildItem -Path "$env:LOCALAPPDATA\Microsoft\WindowsApps" -Filter "*AppInstaller*" -ErrorAction SilentlyContinue | ForEach-Object {
            if ((Test-Path $_.FullName) -and ($_.Extension -in @('.exe', '.dll'))) {
              Move-Item -Path $_.FullName -Destination "$($_.FullName).bak" -Force -ErrorAction SilentlyContinue
            }
          }
          $env:Path = ($env:Path -split ';' | Where-Object { $_ -notlike '*WindowsApps*' }) -join ';'
          Write-Host "  Git:    $(try { git --version } catch { 'âœ“ å·²ç§»é™¤' })"
          Write-Host "  winget: $(try { winget --version } catch { 'âœ“ å·²ç§»é™¤' })"
          Write-Host ""

      - name: Run install script (Full User Experience)
        shell: pwsh
        run: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "ğŸ“‹ Windows å¹²å‡€ç¯å¢ƒå®‰è£…æµ‹è¯•" -ForegroundColor Cyan
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""

          Write-Host "ğŸ“Š å®‰è£…å‰çŠ¶æ€:" -ForegroundColor Yellow
          Write-Host "  Git:    $(try { git --version } catch { 'æœªå®‰è£…' })"
          Write-Host "  Node:   $(try { node --version } catch { 'æœªå®‰è£…' })"
          Write-Host "  pnpm:   $(try { pnpm --version } catch { 'æœªå®‰è£…' })"
          Write-Host "  winget: $(try { winget --version } catch { 'æœªå®‰è£…' })"
          Write-Host ""
          Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray
          Write-Host ""

          Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
          .\install.ps1

          Write-Host ""
          Write-Host "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -ForegroundColor Gray
          Write-Host ""

      - name: Verify & Report Results
        shell: pwsh
        run: |
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          $pnpmHome = "$env:LOCALAPPDATA\pnpm"
          if (Test-Path $pnpmHome) { $env:Path = "$pnpmHome;$env:Path" }
          $npmPath = "$env:APPDATA\npm"
          if (Test-Path $npmPath) { $env:Path = "$npmPath;$env:Path" }

          Write-Host "âœ… å®‰è£…ç»“æœéªŒè¯:" -ForegroundColor Green
          Write-Host "  Git:      $(try { git --version } catch { 'âŒ æœªå®‰è£…' })"
          Write-Host "  Node.js:  $(try { node --version } catch { 'âŒ æœªå®‰è£…' })"
          Write-Host "  pnpm:     $(try { pnpm --version } catch { 'âŒ æœªå®‰è£…' })"
          Write-Host "  OpenClaw: $(try { openclaw --version } catch { 'âŒ æœªå®‰è£…' })"
